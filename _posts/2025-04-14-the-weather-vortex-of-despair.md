---
title: "The Weather Vortex of Despair"
date: 2025-04-14T20:00:00+01:00
categories:
  - blog
  - dev
tags:
  - Planets
  - Atmosphere
  - Environment
---

One of the major features that's been in my mind about Itinerant since its inception is that in some way, the worlds within the Itinerant universe should be constantly evolving and changing. I feel that a big problem with procedurally-generated planets is that it's hard to make them really seem 'alive'; often they are just a collection of predetermined biomes that are scattered across a planet using noise functions. It all gets a bit repetitive after a while, and there isn't necessarily much that changes from one place to another.

One way to stop this from happening in Itinerant would be to have a method of determining where vegetation should grow based on the surrounding conditions. I tried to break this down further by thinking I could set things up so you could plant trees in the ground and each tree would grow uniquely depending on local environmental factors.

It seemed a good place to start would be to try to simulate light and heat on a planet. I figured, if I can quickly calculate how much average light would fall on a specific point on the planet, plus what the surface temperature was, I could make a guess at how much vegetation would grow. Factor in a few other things like rainfall and ground type, and my biomes would start generating themselves in (hopefully) unique and dynamic ways not just from planet to planet, but that planets themselves could vary massively across their surfaces.

However, the more I thought about this, the more complex it got. You can fairly easily determine the average amount of sunlight a planet will get at any specific point on its surface if you know a few basic variables such as rotation speed, axial tilt, distance the planet is from its star and the output of the star. But of course, that's only part of the story - how these factors interact with the atmosphere, and how the atmosphere interacts with the surrounding terrain is a far more daunting undertaking. Before you know it (as I've found out these past few weeks), you're thinking about how you calculate air movements over an entire planet just to know what the surface temperature and air pressure is going to be on a single spot on the ground.

Since I've spent so much time building up the data formats, storage mediums, rendering mechanisms and building mechanics for the planets, I hadn't given much thought about how I would turn these static environments into living, breathing worlds that slowly change over time. I knew I'd be able to do it somehow, and I genuinely thought I'd just be able to bolt a single environmental metric (such as surface temperature) into my model fairly easily, and then I'd slowly over time add more realism to it as I wnet along.

I got off to a good start - I understand that stars emit something we refer to as flux, which is a value of energy per m2 (W/m2), and that flux decreases over distance using the inverse square law. I also knew that you can pretty easily figure out how much of this flux actually hits the planet if you know the surface area of the planet (which itself can be determined from the radius).

You can take this further by factoring in the albedo of the planet, which can be used to determine how much energy is reflected into space. Once you're at that point, figuring out how much flux hits any particular point on the planet becomes fairly trivial - assuming the planet is roughly a sphere and taking a line through the center of the sphere out to the point on the surface, you can figure out the angle between that and the sun and know roughly how much flux will hit that point (eg, if the sun is directly overhead, 100% of the calculated flux will hit it. But as the sun moves to more oblique angles, less and less of the flux will heat the surfce).

[there's obviously a lot more to it that this, such as the fact the sunlight has to travel through more atmosphere at the poles, but you get the idea]

I messed about with the formulae that govern these elements for quite a while, hoping I'd get a good idea of what the temperature might be at any point on a planet, and indeed I guess I did get that, but it turned out it wasn't what I wanted. When you're looking at flux values and not considering the atmosphere, you're basically left with temperature values that are more like the planet Mercury - ridiculously high on the side facing the sun, and near to zero degrees Kelvin on the dark side.

{% include figure popup=true image_path="/assets/images/blog/planet_temperature.png" alt="Average solar flux hitting the planet." caption="My first attempt looked promising - I rendered my planet showing the average solar flux over the course of a day. Red indicates more flux. It worked, but it was translating into temperatures near zero degrees Kelvin at the poles." %}

{% include figure popup=true image_path="/assets/images/blog/planet_temperature_2.png" alt="Intantaneous solar flux hitting the planet." caption="This second view show the solar flux hitting the planet at the specific moment the screenshot was captured - red indicating higher amounts of flux, pointed directly towards the sun." %}

I kept thinking I just needed to retain some heat on the dark side, and not let the planet warm up so quickly on the light side, and I'd get some sort of temperate climate where stuff can grow. But I also wanted to do this using something leaning towards actual physics rather than hacking something together - my view is I want stuff to spontaneously grow because the maths say it should, rather than me hacking stuff into appearing. I lost track of how many hours I spent trying to account for things like the specific heat capacity of the surface to slow the rate of temperature loss at night down (this didn't half get complicated - you have to know the mass of the material that's losing heat, so I was trying to make estimates as to the mass of rock under the player's feet that might be storing heat, plus the mass of the atmosphere above the player), trying to understand how the greenhouse effect helps trap heat in at night, factoring in the altitude at each spot on the planet... and then thinking, maybe I need to account for air movements as well - hot, higher pressure air will move towards lower pressure colder air, potentially distributing heat that way - suddenly I was now trying to simulate wind, all because I wanted to add a little graphic somewhere to say what the temperature was when you were standing on the planet.

Whatever I did, my planet with an atmosphere was become a variety of temperatures on the light side (ranging from excruciatingly hot to not hot enough), and near to zero degrees Kelvin on the dark side and at the poles. I guess I had a good base for planets and asteroids without an atmosphere, which will come in handy later, but I just wanted to know the surface temperature of the first procedural planet my system had spat out and try to figure out if my player was going to die or not.

At this point I have to say I did feel somewhat dejected. It felt a lot like I'd spent several years building a rendering and creation engine and I was going to get stumped by the survival mechanics, which I thought I'd be able to hook up pretty quickly. I know I could 'fake' it somehow, but I just wanted the variety and unpredictability in my systems that I feel can only come from something that's more simulated on real physics.

I even turned to AI to help. As I often find at the moment (and I don't know how anyone uses AI to do anything useful in coding that actually saves time), it sort of gaslit me and gave me something that seemed kind of usable, but the more I looked into it, the more it looked like complete junk. I thought it had some good ideas in there and I spent many, many hours iterating over those ideas thinking I'd get to somewhere good - in the end I had a mad planet with extremely violent winds, massive swings in temperature and just no survivability rating.. and it was still zero degrees Kelvin on the dark side, just with these really high winds that made no sense.

In the end I had to admit something I knew at the start of this - I do not have a degree or PhD in climatology, fluid dynamics, thermal dynamics, or any of that stuff that would actually help me figure this out, I don't have supercomputers to simulate real weather patterns... and I don't yet have access to an AI model that can do it for me D:

But I got to thinking that really there must be some kind of solution out there that could help me, and my research of the past few weeks at least meant I'd learnt a few key words I could throw into search engines and maybe guide me to something useful. I forget which words really helped but the next time I'm at a party with a bunch of scientists (which is proabbly never going to happen) I can now nod knowingly if someone says something like 'Boltzmann Constant' or 'Lapse rate', 'Relative vorticity'...

For me, it's sometimes when I kind of give up and take a step back that I then find the solution I was looking for, and in this case it came in the form of a piece of software called SpeedyWeather.

Now this managed to unfurl a whole *other* can of worms because it's written in Julia, which is a language I don't think I'd heard of before, so suddenly I traded my learning about weather with learning about Julia, and wondering if I could get it to interact with C# in a way that made sense... but what I did manage to do with SpeedyWeather is feed it my land terrain data, a land-sea mask so I could tell it where water was on the planet, some parameters about the size and rotation of the planet.. and, lo and behold, it started simulating some weather information for me that looked like actual weather!

I'm genuinely impressed by what it can do, especially considering it's available under an MIT license and the people involved in the project seem very, very helpful and super engaged on GitHub. Often you find these kinds of open source projects and then realise the last commit was several years ago, the issues tab has someone asking 'has this been abandoned', the one thing you really need to work doesn't, and the code is so complex that you don't stand a chance of adding what you need. Not so here. It just works, and it works well!

So here we have it. This is a bit of a milestone day because I set up a service on my dev machine that simulates the weather on my planet and consistently updates it in 30 second increments. I know wind speeds, surface pressure, and temperatures as different layers above the planet's surface and I'm recalculating it in close to real-time (with a fair bit of interpolation going on at times, to be fair - I set up SpeedyWeather to give me conditions every hour and then interpolate the conditions from one hour to the next).

So I now have a background service running that I can add to going forwards and keep my planet evolving in real-time. It's not just that this means I have a route to getting working weather on the planet, it means I have a way of interacting and modifying terrain and the stuff the player is building as the game progresses. I want stuff like your base to get covered in dust when it's windy and dry, or leaks to appear if it's raining. This is now possible even when the player is away from the game and it opens up a lot of doors in terms of making the universe I want to create more dynamic and 'real'.

{% include figure popup=true image_path="/assets/images/blog/proxima-d-surface-temp.gif" alt="Surface temperature changing over a 24-hour period." caption="Surface temperature changing over a 24-hour period." %}

{% include figure popup=true image_path="/assets/images/blog/proxima-d-rel-vorticity.gif" alt="Relative vorticity changing over a 24-hour period." caption="Relative vorticity changing over a 24-hour period." %}
